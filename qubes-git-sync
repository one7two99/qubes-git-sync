#!/bin/sh
# qubes-git-sync: Synchronize Git repositories between dom0, SyncVM, and GitHub
#
# Workflow:
#   - dom0 edits and commits changes
#   - dom0 creates a git bundle and transfers it to SyncVM
#   - SyncVM pulls from the bundle and pushes to GitHub
#
# Assumptions:
#   - dom0 is the primary place for edits
#   - SyncVM has SSH access to GitHub
#   - GitHub is treated as a normal repository (history preserved)

set -euo pipefail

SYNCVM="my-git-sync"
GITHUB_USER="your-github-username"   # <-- adjust this
ALL_REPOS="my-qubes another-repo scripts-docs"
LOGFILE="$HOME/.qubes-git-sync.log"

CMD="${1:-}"
ARG="${2:-}"

usage() {
    cat <<EOF
Usage: $0 {gitpush|gitpull} <repository>|--all

Commands:
  gitpush  Create a git bundle in dom0, import it in $SYNCVM, and push to GitHub
  gitpull  Pull latest commits from GitHub in $SYNCVM and sync back to dom0

Options:
  -h, --help   Show this help
  --all        Run for all repos in ALL_REPOS

Examples:
  $0 gitpush my-qubes
  $0 gitpull --all
EOF
    exit 1
}

log() {
    local level="$1"; shift
    local msg="$*"
    local ts
    ts="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "[$ts] [$level] $msg" | tee -a "$LOGFILE"
}

ensure_repo_in_syncvm() {
    local repo="$1"
    if ! qvm-run "$SYNCVM" "test -d ~/repos/$repo/.git"; then
        log INFO "Cloning '$repo' in $SYNCVM ..."
        if ! qvm-run "$SYNCVM" "mkdir -p ~/repos && cd ~/repos && git clone git@github.com:$GITHUB_USER/$repo.git"; then
            log FAIL "Clone of '$repo' failed. Check SSH/network."
            return 1
        fi
    fi
}

do_action() {
    local action="$1"
    local repo="$2"

    case "$action" in
      gitpush)
        if [ ! -d "$HOME/repos/$repo/.git" ]; then
            log FAIL "Repo $HOME/repos/$repo not found in dom0."
            return 1
        fi

        # Ensure SyncVM repo exists
        ensure_repo_in_syncvm "$repo"

        # Create git bundle in dom0
        bundle="/tmp/$repo.bundle"
        cd "$HOME/repos/$repo"
        git bundle create "$bundle" --all || { log FAIL "Bundle creation failed for $repo."; return 1; }

        # Transfer bundle to SyncVM
        cat "$bundle" | qvm-run --pass-io "$SYNCVM" "cat > /tmp/$repo.bundle"

        # Import bundle and push to GitHub
        if qvm-run "$SYNCVM" "
          cd ~/repos/$repo &&
          git fetch /tmp/$repo.bundle refs/heads/*:refs/remotes/bundle/* &&
          git merge bundle/main --ff-only &&
          git push origin main
        "; then
            log OK "Repo '$repo' successfully pushed from dom0 to GitHub."
        else
            log FAIL "Push for '$repo' failed."
            return 1
        fi
        rm -f "$bundle"
        ;;

      gitpull)
        ensure_repo_in_syncvm "$repo" || { log FAIL "Setup for '$repo' failed."; return 1; }
        if qvm-run "$SYNCVM" "cd ~/repos/$repo && git pull --ff-only"; then
            # Sync back to dom0
            tarfile="/tmp/$repo-sync.tar"
            qvm-run --pass-io "$SYNCVM" "tar -C ~/repos/$repo -cf - ." | tar -C "$HOME/repos/$repo" -xf -
            log OK "Repo '$repo' updated from GitHub into dom0."
        else
            log FAIL "Git pull failed for '$repo'."
            return 1
        fi
        ;;

      *)
        usage
        ;;
    esac
}

case "$CMD" in
  -h|--help|"")
    usage
    ;;

  gitpush|gitpull)
    if [ "$ARG" = "--all" ]; then
        total=0; ok=0; fail=0
        for r in $ALL_REPOS; do
            total=$((total+1))
            if do_action "$CMD" "$r"; then
                ok=$((ok+1))
            else
                fail=$((fail+1))
            fi
        done
        log INFO "Summary: $ok successful, $fail failed, total $total."
        [ "$fail" -eq 0 ] || exit "$fail"
    elif [ -n "$ARG" ]; then
        do_action "$CMD" "$ARG"
    else
        usage
    fi
    ;;

  *)
    usage
    ;;
esac
